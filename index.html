<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    td { padding: 4px 6px; vertical-align: middle; }
    label { margin-right: 8px; }
    input[type="text"], select {
      width: 200px;
      padding: 4px;
    }
    .section { margin-top: 20px; }
    .search-result { white-space: pre-wrap; background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 4px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>性能カスタム記録フォーム</h2>

  <div id="g_id_onload"
    data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
    data-callback="onSignIn"
    data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
    data-type="standard"
    data-size="large"
    data-theme="outline"
    data-text="sign_in_with"
    data-shape="rectangular"
    data-logo_alignment="left">
  </div>

  <div id="formArea" class="hidden">
    <div class="section">
      <label for="userName">記録者名:</label>
      <select id="userName" disabled></select>
    </div>

    <div class="section">
      <label for="vehicleNumber">車両番号:</label>
      <input type="text" id="vehicleNumber" required>
      <label for="ownerName">オーナー名:</label>
      <input type="text" id="ownerName" required>
    </div>

    <div class="section">
      <table>
        <tr>
          <td>エンジン:</td>
          <td>
            <label><input type="radio" name="engine" value="ティア1">ティア1</label>
            <label><input type="radio" name="engine" value="ティア2">ティア2</label>
            <label><input type="radio" name="engine" value="ティア3">ティア3</label>
            <label><input type="radio" name="engine" value="ティア4">ティア4</label>
            <label><input type="radio" name="engine" value="ティア5">ティア5</label>
          </td>
        </tr>
        <tr>
          <td>ブレーキ:</td>
          <td>
            <label><input type="radio" name="brake" value="ティア1">ティア1</label>
            <label><input type="radio" name="brake" value="ティア2">ティア2</label>
            <label><input type="radio" name="brake" value="ティア3">ティア3</label>
          </td>
        </tr>
        <tr>
          <td>ミッション:</td>
          <td>
            <label><input type="radio" name="transmission" value="ティア1">ティア1</label>
            <label><input type="radio" name="transmission" value="ティア2">ティア2</label>
            <label><input type="radio" name="transmission" value="ティア3">ティア3</label>
            <label><input type="radio" name="transmission" value="ティア4">ティア4</label>
          </td>
        </tr>
        <tr>
          <td>サス:</td>
          <td>
            <label><input type="radio" name="suspension" value="ティア1">ティア1</label>
            <label><input type="radio" name="suspension" value="ティア2">ティア2</label>
            <label><input type="radio" name="suspension" value="ティア3">ティア3</label>
            <label><input type="radio" name="suspension" value="ティア4">ティア4</label>
            <label><input type="radio" name="suspension" value="ティア5">ティア5</label>
          </td>
        </tr>
        <tr>
          <td>その他:</td>
          <td>
            <label><input type="checkbox" id="armor">アーマー</label>
            <label><input type="checkbox" id="turbo">ターボ</label>
            <label><input type="checkbox" id="harness">ハーネス</label>
            <label><input type="checkbox" id="nos">NOS</label>
          </td>
        </tr>
      </table>
    </div>

    <div class="section">
      <button onclick="submitForm()">記録する</button>
    </div>

    <div class="section">
      <h3>検索</h3>
      <label for="searchQuery">車両番号またはオーナー名:</label>
      <input type="text" id="searchQuery">
      <button onclick="searchData()">検索</button>
      <div id="searchResult" class="search-result"></div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbymLM9CdJmCjGLB92flgYE7VnOEeuYn3d2tOUHGFe3glz1ggKPhdOYr_aMnrT761Ljw/exec";
    let idToken = "";

    function onSignIn(response) {
      idToken = response.credential;
      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({ token: idToken, mode: "auth" }),
        headers: { "Content-Type": "application/json" },
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          document.getElementById("formArea").classList.remove("hidden");
          document.querySelector(".g_id_signin").classList.add("hidden");
          const userNameSelect = document.getElementById("userName");
          userNameSelect.innerHTML = "";
          data.names.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            userNameSelect.appendChild(opt);
          });
          userNameSelect.value = data.userName;
        } else {
          alert("認証エラー: " + data.message);
        }
      });
    }

    function submitForm() {
      const vehicleNumber = document.getElementById("vehicleNumber").value.toUpperCase();
      const ownerName = document.getElementById("ownerName").value;
      const engine = getRadioValue("engine");
      const brake = getRadioValue("brake");
      const transmission = getRadioValue("transmission");
      const suspension = getRadioValue("suspension");
      const armor = document.getElementById("armor").checked;
      const turbo = document.getElementById("turbo").checked;
      const harness = document.getElementById("harness").checked;
      const nos = document.getElementById("nos").checked;
      const userName = document.getElementById("userName").value;

      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
          token: idToken,
          vehicleNumber,
          ownerName,
          engine,
          brake,
          transmission,
          suspension,
          armor,
          turbo,
          harness,
          nos
        }),
        headers: { "Content-Type": "application/json" },
      })
      .then(res => res.text())
      .then(msg => alert(msg));
    }

    function getRadioValue(name) {
      const selected = document.querySelector(`input[name="${name}"]:checked`);
      return selected ? selected.value : "";
    }

    function searchData() {
      const query = document.getElementById("searchQuery").value.trim();
      if (!query) return;

      fetch(`${WEB_APP_URL}?mode=search&query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          const resultDiv = document.getElementById("searchResult");
          if (data.length === 0) {
            resultDiv.textContent = "該当データがありません。";
          } else {
            resultDiv.innerHTML = data.map(entry => {
              return `日時: ${entry.date} / 記録者: ${entry.userName}
車両番号: ${entry.vehicleNumber} / オーナー名: ${entry.ownerName}
エンジン: ${entry.engine}
ブレーキ: ${entry.brake}
ミッション: ${entry.transmission}
サス: ${entry.suspension}
アーマー: ${entry.armor}, ターボ: ${entry.turbo}, ハーネス: ${entry.harness}, NOS: ${entry.nos}`;
            }).join("\n\n");
          }
        });
    }
  </script>
</body>
</html>
