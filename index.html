<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table td:first-child { width: 120px; vertical-align: top; }
    input[type="text"], select { width: 200px; }
    label { margin-right: 8px; }
  </style>
</head>
<body>
  <h2>性能カスタム記録フォーム</h2>

  <div id="loginSection">
    <div id="g_id_onload"
      data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <div id="formSection" style="display:none;">
    <form id="customForm">
      <table>
        <tr>
          <td>記録者名:</td>
          <td><select id="userName" name="userName" required></select></td>
        </tr>
        <tr>
          <td>車両番号:</td>
          <td><input type="text" name="vehicleNumber" required></td>
        </tr>
        <tr>
          <td>オーナー名:</td>
          <td><input type="text" name="ownerName" required></td>
        </tr>
        <tr>
          <td>エンジン:</td>
          <td>
            <label><input type="radio" name="engine" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="engine" value="ティア2">ティア2</label>
            <label><input type="radio" name="engine" value="ティア3">ティア3</label>
            <label><input type="radio" name="engine" value="ティア4">ティア4</label>
            <label><input type="radio" name="engine" value="ティア5">ティア5</label>
          </td>
        </tr>
        <tr>
          <td>ブレーキ:</td>
          <td>
            <label><input type="radio" name="brake" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="brake" value="ティア2">ティア2</label>
            <label><input type="radio" name="brake" value="ティア3">ティア3</label>
          </td>
        </tr>
        <tr>
          <td>ミッション:</td>
          <td>
            <label><input type="radio" name="mission" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="mission" value="ティア2">ティア2</label>
            <label><input type="radio" name="mission" value="ティア3">ティア3</label>
            <label><input type="radio" name="mission" value="ティア4">ティア4</label>
          </td>
        </tr>
        <tr>
          <td>サス:</td>
          <td>
            <label><input type="radio" name="suspension" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="suspension" value="ティア2">ティア2</label>
            <label><input type="radio" name="suspension" value="ティア3">ティア3</label>
            <label><input type="radio" name="suspension" value="ティア4">ティア4</label>
            <label><input type="radio" name="suspension" value="ティア5">ティア5</label>
          </td>
        </tr>
        <tr>
          <td>その他:</td>
          <td>
            <label><input type="checkbox" name="armor">アーマー</label>
            <label><input type="checkbox" name="turbo">ターボ</label>
            <label><input type="checkbox" name="harness">ハーネス</label>
            <label><input type="checkbox" name="nos">NOS</label>
          </td>
        </tr>
      </table>
      <br>
      <button type="submit">送信</button>
    </form>
    <div id="message"></div>
  </div>

  <script>
    let userEmail = "";

    function handleCredentialResponse(response) {
      const data = { id_token: response.credential };
      fetch("https://script.google.com/macros/s/AKfycby8P6fjFcbLyQuJ5jwNGiWfnV5HfL5-svxPHlj21I9Dtauq4nelgR7MLIuSd9k4x2Qc/exec", {
        method: "POST",
        body: JSON.stringify({ mode: "verify", token: response.credential }),
      })
      .then(res => res.json())
      .then(res => {
        if (res.status === "success") {
          userEmail = res.email;
          document.getElementById("loginSection").style.display = "none";
          document.getElementById("formSection").style.display = "block";
          loadUserName(userEmail);
        } else {
          alert("許可されていないユーザーです");
        }
      });
    }

    function loadUserName(email) {
      fetch("https://script.google.com/macros/s/AKfycby8P6fjFcbLyQuJ5jwNGiWfnV5HfL5-svxPHlj21I9Dtauq4nelgR7MLIuSd9k4x2Qc/exec?mode=getName&email=" + encodeURIComponent(email))
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("userName");
          select.innerHTML = `<option value="${data.name}">${data.name}</option>`;
        });
    }

    document.getElementById("customForm").addEventListener("submit", e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const json = Object.fromEntries(formData.entries());
      json.armor = formData.get("armor") ? "ON" : "OFF";
      json.turbo = formData.get("turbo") ? "ON" : "OFF";
      json.harness = formData.get("harness") ? "ON" : "OFF";
      json.nos = formData.get("nos") ? "ON" : "OFF";
      json.mode = "submit";
      fetch("https://script.google.com/macros/s/AKfycby8P6fjFcbLyQuJ5jwNGiWfnV5HfL5-svxPHlj21I9Dtauq4nelgR7MLIuSd9k4x2Qc/exec", {
        method: "POST",
        body: JSON.stringify(json),
      })
      .then(res => res.json())
      .then(res => {
        document.getElementById("message").textContent = res.message;
        if (res.status === "success") {
          document.getElementById("customForm").reset();
        }
      });
    });
  </script>
</body>
</html>
