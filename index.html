<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    .section { margin-bottom: 20px; }
    .radio-group label { display: block; }
    button { padding: 10px 20px; }
  </style>
</head>
<body>

  <h1>性能カスタム記録フォーム</h1>

  <div id="login-box">
    <div id="g_id_onload"
         data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
         data-callback="onSignIn"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
  </div>

  <div id="form-box" style="display:none;">
    <form id="customForm">

      <div class="section">
        <label for="userName">記録者名</label>
        <select name="userName" id="userName" required></select>
      </div>

      <div class="section">
        <label for="vehicleNumber">車両番号</label>
        <input type="text" name="vehicleNumber" id="vehicleNumber" required>
      </div>

      <div class="section">
        <label for="ownerName">オーナー名</label>
        <input type="text" name="ownerName" id="ownerName" required>
      </div>

      <!-- 性能パーツ入力 -->
      <div class="section">
        <label>エンジン</label>
        <div class="radio-group">
          <label><input type="radio" name="エンジン" value="ティア1"> ティア1</label>
          <label><input type="radio" name="エンジン" value="ティア2"> ティア2</label>
          <label><input type="radio" name="エンジン" value="ティア3"> ティア3</label>
          <label><input type="radio" name="エンジン" value="ティア4"> ティア4</label>
          <label><input type="radio" name="エンジン" value="ティア5"> ティア5</label>
        </div>
      </div>

      <div class="section">
        <label>ブレーキ</label>
        <div class="radio-group">
          <label><input type="radio" name="ブレーキ" value="ティア1"> ティア1</label>
          <label><input type="radio" name="ブレーキ" value="ティア2"> ティア2</label>
          <label><input type="radio" name="ブレーキ" value="ティア3"> ティア3</label>
        </div>
      </div>

      <div class="section">
        <label>トランスミッション</label>
        <div class="radio-group">
          <label><input type="radio" name="トランスミッション" value="ティア1"> ティア1</label>
          <label><input type="radio" name="トランスミッション" value="ティア2"> ティア2</label>
          <label><input type="radio" name="トランスミッション" value="ティア3"> ティア3</label>
        </div>
      </div>

      <div class="section">
        <label>サスペンション</label>
        <div class="radio-group">
          <label><input type="radio" name="サスペンション" value="ティア1"> ティア1</label>
          <label><input type="radio" name="サスペンション" value="ティア2"> ティア2</label>
          <label><input type="radio" name="サスペンション" value="ティア3"> ティア3</label>
          <label><input type="radio" name="サスペンション" value="ティア4"> ティア4</label>
        </div>
      </div>

      <div class="section">
        <label><input type="checkbox" name="アーマー" value="ON"> アーマー</label>
        <label><input type="checkbox" name="ターボ" value="ON"> ターボ</label>
        <label><input type="checkbox" name="ハーネス" value="ON"> ハーネス</label>
        <label><input type="checkbox" name="NOS" value="ON"> NOS</label>
      </div>

      <button type="submit">送信</button>
    </form>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwD4QACHCv2BiIhqoHMnnRdxjINe-JRUFJNh1fY0ncmBNQjzGxNIV-G8upBHYi8bXcJ/exec";
    let userEmail = "";

    function onSignIn(response) {
      const id_token = response.credential;
      const payload = JSON.parse(atob(id_token.split(".")[1]));
      userEmail = payload.email;

      fetch(`${GAS_URL}?email=${encodeURIComponent(userEmail)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.allowed) {
            alert("アクセス権がありません");
            return;
          }

          const userSelect = document.getElementById("userName");
          userSelect.innerHTML = "";

          data.names.forEach(name => {
            const option = document.createElement("option");
            option.value = option.textContent = name;
            if (name === data.defaultName) option.selected = true;
            userSelect.appendChild(option);
          });

          document.getElementById("login-box").style.display = "none";
          document.getElementById("form-box").style.display = "block";
        });
    }

    document.getElementById("customForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const obj = {};
      formData.forEach((value, key) => {
        if (obj[key]) {
          if (!Array.isArray(obj[key])) obj[key] = [obj[key]];
          obj[key].push(value);
        } else {
          obj[key] = value;
        }
      });

      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(obj),
        headers: { "Content-Type": "application/json" }
      })
        .then(res => res.text())
        .then(text => {
          alert("送信が完了しました！");
          document.getElementById("customForm").reset();
        })
        .catch(err => alert("送信エラー: " + err));
    });
  </script>

</body>
</html>
