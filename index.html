<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .form-row label {
      width: 120px;
    }
    .form-row input[type="text"],
    .form-row select {
      width: 200px;
      padding: 4px;
    }
    .tier-group label {
      margin-right: 6px;
    }
    .checkbox-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .submit-button {
      margin-top: 15px;
    }
    #searchResults {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>性能カスタム記録フォーム</h2>

  <!-- Googleログイン -->
  <div id="g_id_onload"
       data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="true">
  </div>
  <div class="g_id_signin" data-type="standard"></div>
  <div id="user-info"></div>

  <form id="customForm">
    <div class="form-row">
      <label for="owner">記録者名:</label>
      <select id="owner" name="owner" required></select>
    </div>
    <div class="form-row">
      <label for="vehicle">車両番号:</label>
      <input type="text" id="vehicle" name="vehicle" required>
    </div>

    <table>
      <tr>
        <th>項目</th>
        <th>ティア選択</th>
      </tr>
      <tr>
        <td>エンジン</td>
        <td class="tier-group">
          <label><input type="radio" name="engine" value="1">1</label>
          <label><input type="radio" name="engine" value="2">2</label>
          <label><input type="radio" name="engine" value="3">3</label>
          <label><input type="radio" name="engine" value="4">4</label>
          <label><input type="radio" name="engine" value="5">5</label>
        </td>
      </tr>
      <tr>
        <td>ブレーキ</td>
        <td class="tier-group">
          <label><input type="radio" name="brake" value="1">1</label>
          <label><input type="radio" name="brake" value="2">2</label>
          <label><input type="radio" name="brake" value="3">3</label>
        </td>
      </tr>
      <tr>
        <td>トランスミッション</td>
        <td class="tier-group">
          <label><input type="radio" name="transmission" value="1">1</label>
          <label><input type="radio" name="transmission" value="2">2</label>
          <label><input type="radio" name="transmission" value="3">3</label>
        </td>
      </tr>
      <tr>
        <td>サスペンション</td>
        <td class="tier-group">
          <label><input type="radio" name="suspension" value="1">1</label>
          <label><input type="radio" name="suspension" value="2">2</label>
          <label><input type="radio" name="suspension" value="3">3</label>
          <label><input type="radio" name="suspension" value="4">4</label>
        </td>
      </tr>
      <tr>
        <td>その他</td>
        <td class="checkbox-group">
          <label><input type="checkbox" name="armor">アーマー</label>
          <label><input type="checkbox" name="turbo">ターボ</label>
          <label><input type="checkbox" name="harness">ハーネス</label>
          <label><input type="checkbox" name="nos">NOS</label>
        </td>
      </tr>
    </table>

    <button type="submit" class="submit-button">送信</button>
  </form>

  <hr>

  <div class="form-row">
    <label for="searchInput">検索:</label>
    <input type="text" id="searchInput" placeholder="車両番号または記録者名">
    <button onclick="search()">検索</button>
  </div>
  <div id="searchResults"></div>

  <script>
    let idToken = "";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyT8DiQ3HDADEsDzptcA_i4k116fYfszL1IBMSfTq-7jOAMOLbWg-QDsoo8EcK3AJ3T/exec";

    function handleCredentialResponse(response) {
      idToken = response.credential;
      fetch(GAS_URL + "?mode=verify", {
        method: "POST",
        body: JSON.stringify({ token: idToken })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("user-info").innerText = `ログイン中: ${data.email}`;
        populateOwnerOptions(data.allowedNames, data.name);
      });
    }

    function populateOwnerOptions(names, currentName) {
      const select = document.getElementById("owner");
      select.innerHTML = "";
      names.forEach(name => {
        const option = document.createElement("option");
        option.value = option.textContent = name;
        if (name === currentName) option.selected = true;
        select.appendChild(option);
      });
    }

    document.getElementById("customForm").addEventListener("submit", e => {
      e.preventDefault();
      const form = e.target;
      const data = {
        token: idToken,
        owner: form.owner.value,
        vehicle: form.vehicle.value,
        engine: form.engine.value,
        brake: form.brake.value,
        transmission: form.transmission.value,
        suspension: form.suspension.value,
        armor: form.armor.checked,
        turbo: form.turbo.checked,
        harness: form.harness.checked,
        nos: form.nos.checked
      };
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(res => res.text())
        .then(res => {
          alert("送信が完了しました！");
          form.reset();
        });
    });

    function search() {
      const query = document.getElementById("searchInput").value;
      fetch(GAS_URL + "?search=" + encodeURIComponent(query))
        .then(res => res.json())
        .then(results => {
          const container = document.getElementById("searchResults");
          if (results.length === 0) {
            container.innerHTML = "<p>結果が見つかりませんでした。</p>";
            return;
          }
          let html = "<table><tr><th>記録者</th><th>車両番号</th><th>エンジン</th><th>ブレーキ</th><th>トランス</th><th>サス</th><th>アーマー</th><th>ターボ</th><th>ハーネス</th><th>NOS</th></tr>";
          results.forEach(row => {
            html += `<tr><td>${row.owner}</td><td>${row.vehicle}</td><td>${row.engine}</td><td>${row.brake}</td><td>${row.transmission}</td><td>${row.suspension}</td><td>${row.armor}</td><td>${row.turbo}</td><td>${row.harness}</td><td>${row.nos}</td></tr>`;
          });
          html += "</table>";
          container.innerHTML = html;
        });
    }
  </script>
</body>
</html>
