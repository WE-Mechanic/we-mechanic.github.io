<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .row {
      display: flex;
      margin-bottom: 10px;
      align-items: center;
    }
    .row label {
      width: 120px;
    }
    input[type="text"], select {
      width: 25%;
      padding: 5px;
      margin-left: 5px;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
    }
    td {
      padding: 5px 10px;
    }
    .section-title {
      margin-top: 20px;
      font-weight: bold;
    }
    .result-block {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>性能カスタム記録フォーム</h2>

  <div id="g_id_onload"
       data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
       data-callback="onSignIn">
  </div>

  <div class="g_id_signin" data-type="standard"></div>

  <div id="formContainer" style="display:none;">
    <form id="customForm">
      <div class="row">
        <label>記録者:</label>
        <select id="userSelect" name="user" required></select>
      </div>
      <div class="row">
        <label>車両番号:</label>
        <input type="text" name="carNumber" required />
      </div>
      <div class="row">
        <label>オーナー名:</label>
        <input type="text" name="owner" required />
      </div>

      <div class="section-title">性能パーツ</div>
      <table>
        <tr>
          <td>エンジン:</td>
          <td>
            <label><input type="radio" name="engine" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="engine" value="ティア2">ティア2</label>
            <label><input type="radio" name="engine" value="ティア3">ティア3</label>
            <label><input type="radio" name="engine" value="ティア4">ティア4</label>
            <label><input type="radio" name="engine" value="ティア5">ティア5</label>
          </td>
        </tr>
        <tr>
          <td>ブレーキ:</td>
          <td>
            <label><input type="radio" name="brake" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="brake" value="ティア2">ティア2</label>
            <label><input type="radio" name="brake" value="ティア3">ティア3</label>
          </td>
        </tr>
        <tr>
          <td>ミッション:</td>
          <td>
            <label><input type="radio" name="mission" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="mission" value="ティア2">ティア2</label>
            <label><input type="radio" name="mission" value="ティア3">ティア3</label>
          </td>
        </tr>
        <tr>
          <td>サス:</td>
          <td>
            <label><input type="radio" name="suspension" value="ティア1" required>ティア1</label>
            <label><input type="radio" name="suspension" value="ティア2">ティア2</label>
            <label><input type="radio" name="suspension" value="ティア3">ティア3</label>
            <label><input type="radio" name="suspension" value="ティア4">ティア4</label>
          </td>
        </tr>
        <tr>
          <td>その他:</td>
          <td>
            <label><input type="checkbox" name="armor">アーマー</label>
            <label><input type="checkbox" name="turbo">ターボ</label>
            <label><input type="checkbox" name="harness">ハーネス</label>
            <label><input type="checkbox" name="nos">NOS</label>
          </td>
        </tr>
      </table>

      <button type="submit">記録する</button>
    </form>

    <div class="section-title">カスタム検索</div>
    <div class="row">
      <label>車両番号またはオーナー名:</label>
      <input type="text" id="searchInput" />
      <button onclick="search()">検索</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    let userEmail = "";
    const scriptURL = "https://script.google.com/macros/s/AKfycbxO8p9Nm0-UaQ8Ro5FxA4CR1Ft5qWuszpprgD53I67tIGyWdKJMxsOJq3s61fcdtDD-/exec";

    function onSignIn(response) {
      const idToken = response.credential;
      fetch(scriptURL + "?mode=verify", {
        method: "POST",
        body: JSON.stringify({ token: idToken }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.allowed) {
          userEmail = data.email;
          document.getElementById("formContainer").style.display = "block";
          loadUsers();
        } else {
          alert("アクセスが許可されていません");
        }
      });
    }

    function loadUsers() {
      fetch(scriptURL + "?mode=users")
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("userSelect");
          data.users.forEach(user => {
            const option = document.createElement("option");
            option.value = user.name;
            option.textContent = user.name;
            if (user.email === userEmail) option.selected = true;
            select.appendChild(option);
          });
          select.disabled = true;
        });
    }

    document.getElementById("customForm").addEventListener("submit", e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      data.armor = formData.has("armor") ? "ON" : "OFF";
      data.turbo = formData.has("turbo") ? "ON" : "OFF";
      data.harness = formData.has("harness") ? "ON" : "OFF";
      data.nos = formData.has("nos") ? "ON" : "OFF";

      fetch(scriptURL + "?mode=submit", {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(result => {
        alert("記録しました！");
        e.target.reset();
      });
    });

    function search() {
      const keyword = document.getElementById("searchInput").value;
      fetch(scriptURL + "?mode=search&keyword=" + encodeURIComponent(keyword))
        .then(res => res.json())
        .then(data => {
          const resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = "";
          if (data.results.length === 0) {
            resultsDiv.textContent = "該当データがありません。";
            return;
          }
          data.results.forEach(item => {
            const block = document.createElement("div");
            block.className = "result-block";
            block.textContent =
              `日時: ${item.timestamp} / 記録者: ${item.user}\n` +
              `車両番号: ${item.carNumber} / オーナー名: ${item.owner}\n` +
              `エンジン: ${item.engine}\n` +
              `ブレーキ: ${item.brake}\n` +
              `ミッション: ${item.mission}\n` +
              `サス: ${item.suspension}\n` +
              `アーマー: ${item.armor}, ターボ: ${item.turbo}, ハーネス: ${item.harness}, NOS: ${item.nos}`;
            resultsDiv.appendChild(block);
          });
        });
    }
  </script>
</body>
</html>
