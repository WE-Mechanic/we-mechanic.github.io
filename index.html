<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    input, select {
      margin: 4px 0;
      padding: 4px;
    }
    table {
      border-collapse: collapse;
    }
    td {
      padding: 4px 8px;
      vertical-align: middle;
    }
    .form-group {
      margin-bottom: 12px;
    }
    .tier-group label {
      margin-right: 8px;
    }
    .search-result {
      margin-top: 20px;
      white-space: pre-line;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>性能カスタム記録フォーム</h2>

  <div id="g_id_onload"
    data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
    data-callback="handleCredentialResponse"
    data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <form id="customForm" style="display:none;">
    <div class="form-group">
      <label>記録者名：</label>
      <input type="text" id="userName" readonly style="width: 200px;">
    </div>

    <div class="form-group">
      <label>車両番号：</label>
      <input type="text" id="vehicleNumber" required style="width: 200px;">
    </div>

    <div class="form-group">
      <label>オーナー名：</label>
      <input type="text" id="ownerName" required style="width: 200px;">
    </div>

    <table>
      <tr>
        <td>エンジン：</td>
        <td class="tier-group">
          <label><input type="radio" name="engine" value="ティア1">ティア1</label>
          <label><input type="radio" name="engine" value="ティア2">ティア2</label>
          <label><input type="radio" name="engine" value="ティア3">ティア3</label>
          <label><input type="radio" name="engine" value="ティア4">ティア4</label>
          <label><input type="radio" name="engine" value="ティア5">ティア5</label>
        </td>
      </tr>
      <tr>
        <td>ブレーキ：</td>
        <td class="tier-group">
          <label><input type="radio" name="brake" value="ティア1">ティア1</label>
          <label><input type="radio" name="brake" value="ティア2">ティア2</label>
          <label><input type="radio" name="brake" value="ティア3">ティア3</label>
        </td>
      </tr>
      <tr>
        <td>ミッション：</td>
        <td class="tier-group">
          <label><input type="radio" name="transmission" value="ティア1">ティア1</label>
          <label><input type="radio" name="transmission" value="ティア2">ティア2</label>
          <label><input type="radio" name="transmission" value="ティア3">ティア3</label>
          <label><input type="radio" name="transmission" value="ティア4">ティア4</label>
        </td>
      </tr>
      <tr>
        <td>サスペンション：</td>
        <td class="tier-group">
          <label><input type="radio" name="suspension" value="ティア1">ティア1</label>
          <label><input type="radio" name="suspension" value="ティア2">ティア2</label>
          <label><input type="radio" name="suspension" value="ティア3">ティア3</label>
          <label><input type="radio" name="suspension" value="ティア4">ティア4</label>
          <label><input type="radio" name="suspension" value="ティア5">ティア5</label>
        </td>
      </tr>
      <tr>
        <td>その他：</td>
        <td>
          <label><input type="checkbox" id="armor">アーマー</label>
          <label><input type="checkbox" id="turbo">ターボ</label>
          <label><input type="checkbox" id="harness">ハーネス</label>
          <label><input type="checkbox" id="nos">NOS</label>
        </td>
      </tr>
    </table>

    <button type="submit">記録</button>
  </form>

  <hr>

  <div class="form-group">
    <label>検索（車両番号 または オーナー名）：</label>
    <input type="text" id="searchQuery" style="width: 200px;">
    <button onclick="searchData()">検索</button>
  </div>

  <div class="search-result" id="searchResult"></div>

  <script>
    let token = "";
    const scriptURL = "https://script.google.com/macros/s/AKfycbyj3N-BJYKdqj6miJTMsAGl4H-agTpBKWYttjZ9s3WjBmIfflg-K02L_LhzuoVW3zc_/exec";

    function handleCredentialResponse(response) {
      token = response.credential;
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ token, mode: "auth" })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          document.getElementById("userName").value = data.userName;
          document.getElementById("customForm").style.display = "block";
          document.querySelector(".g_id_signin").style.display = "none";
        } else {
          alert("認証失敗：" + data.message);
        }
      });
    }

    document.getElementById("customForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const formData = {
        token,
        vehicleNumber: document.getElementById("vehicleNumber").value.toUpperCase(),
        ownerName: document.getElementById("ownerName").value.toUpperCase(),
        engine: getRadioValue("engine"),
        brake: getRadioValue("brake"),
        transmission: getRadioValue("transmission"),
        suspension: getRadioValue("suspension"),
        armor: document.getElementById("armor").checked,
        turbo: document.getElementById("turbo").checked,
        harness: document.getElementById("harness").checked,
        nos: document.getElementById("nos").checked
      };

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(formData)
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        document.getElementById("customForm").reset();
        document.getElementById("userName").value = formData.userName;
      });
    });

    function getRadioValue(name) {
      const radios = document.getElementsByName(name);
      for (let radio of radios) {
        if (radio.checked) return radio.value;
      }
      return "";
    }

    function searchData() {
      const query = document.getElementById("searchQuery").value.toLowerCase();
      fetch(`${scriptURL}?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          const resultDiv = document.getElementById("searchResult");
          if (data.length === 0) {
            resultDiv.textContent = "結果が見つかりません。";
            return;
          }
          resultDiv.innerHTML = data.map(row => {
            const vn = row.vehicleNumber?.toLowerCase() || "";
            const on = row.ownerName?.toLowerCase() || "";
            if (!vn.includes(query) && !on.includes(query)) return "";

            let parts = [];
            if (row.armor === "ON") parts.push("アーマー");
            if (row.turbo === "ON") parts.push("ターボ");
            if (row.harness === "ON") parts.push("ハーネス");
            if (row.nos === "ON") parts.push("NOS");

            return `日時: ${row.date} / 記録者: ${row.userName} /\n車両番号: ${row.vehicleNumber} / オーナー名: ${row.ownerName}\nエンジン: ${row.engine}\nブレーキ: ${row.brake}\nミッション: ${row.transmission}\nサス: ${row.suspension}\n${parts.length > 0 ? "その他: " + parts.join(", ") : ""}\n`;
          }).filter(Boolean).join("\n---------------------\n");
        });
    }
  </script>
</body>
</html>
