<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .row { display: flex; align-items: center; margin: 5px 0; }
    label { margin-right: 10px; min-width: 100px; }
    input[type="text"], select { width: 200px; }
    .section { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    .radio-group, .checkbox-group { display: flex; gap: 8px; }
    .results { white-space: pre-line; margin-top: 20px; }
  </style>
</head>
<body>

<div id="g_id_onload"
  data-client_id="735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com"
  data-callback="handleCredentialResponse">
</div>
<div class="g_id_signin" data-type="standard"></div>

<div id="formContainer" style="display:none;">
  <h2>性能カスタム記録フォーム</h2>
  <div class="row">
    <label>記録者:</label>
    <select id="userSelect" disabled></select>
  </div>
  <div class="row"><label>車両番号:</label><input type="text" id="carNumber"></div>
  <div class="row"><label>オーナー名:</label><input type="text" id="ownerName"></div>

  <div class="section">
    <div class="row"><label>エンジン:</label><div class="radio-group" id="engine"></div></div>
    <div class="row"><label>ブレーキ:</label><div class="radio-group" id="brake"></div></div>
    <div class="row"><label>トランスミッション:</label><div class="radio-group" id="transmission"></div></div>
    <div class="row"><label>サスペンション:</label><div class="radio-group" id="suspension"></div></div>
    <div class="row"><label>アーマー:</label><input type="checkbox" id="armor"></div>
    <div class="row"><label>ターボ:</label><input type="checkbox" id="turbo"></div>
    <div class="row"><label>ハーネス:</label><input type="checkbox" id="harness"></div>
    <div class="row"><label>NOS:</label><input type="checkbox" id="nos"></div>
  </div>

  <button onclick="submitForm()">記録する</button>

  <div class="section">
    <h3>検索</h3>
    <input type="text" id="searchInput" placeholder="車両番号またはオーナー名">
    <button onclick="search()">検索</button>
    <div id="results" class="results"></div>
  </div>
</div>

<script>
const gasURL = 'https://script.google.com/macros/s/AKfycbyFF5clWcDsZlGJEe1xgoGDAwPEEawhsHfRx5AqLVl3NXuhwHxEBjMV5qv6f8hVIAaG/exec';
let currentUserEmail = '';
let userList = [];

function handleCredentialResponse(response) {
  const idToken = response.credential;
  const payload = JSON.parse(atob(idToken.split('.')[1]));
  currentUserEmail = payload.email;

  fetch(gasURL + '?mode=getUsers')
    .then(res => res.json())
    .then(data => {
      userList = data;
      const user = data.find(u => u.email === currentUserEmail);
      if (user) {
        document.getElementById('formContainer').style.display = 'block';
        const select = document.getElementById('userSelect');
        select.innerHTML = `<option value="${user.name}">${user.name}</option>`;
      } else {
        alert("許可されていないユーザーです");
      }
    });
}

function createRadioButtons(containerId, name, tiers) {
  const container = document.getElementById(containerId);
  for (let i = 1; i <= tiers; i++) {
    const label = document.createElement('label');
    label.innerHTML = `<input type="radio" name="${name}" value="ティア${i}">ティア${i}`;
    container.appendChild(label);
  }
}
['engine', 'brake', 'transmission', 'suspension'].forEach(id => {
  createRadioButtons(id, id, { engine:5, brake:3, transmission:4, suspension:5 }[id]);
});

function submitForm() {
  const data = {
    user: document.getElementById('userSelect').value,
    carNumber: document.getElementById('carNumber').value,
    owner: document.getElementById('ownerName').value,
    engine: getSelectedValue('engine'),
    brake: getSelectedValue('brake'),
    transmission: getSelectedValue('transmission'),
    suspension: getSelectedValue('suspension'),
    armor: document.getElementById('armor').checked,
    turbo: document.getElementById('turbo').checked,
    harness: document.getElementById('harness').checked,
    nos: document.getElementById('nos').checked
  };

  fetch(gasURL, {
    method: 'POST',
    body: JSON.stringify(data)
  }).then(res => res.json())
    .then(res => {
      alert("記録が完了しました");
      document.querySelectorAll('input[type="text"]').forEach(el => el.value = '');
      document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
      document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
    });
}

function getSelectedValue(name) {
  const selected = document.querySelector(`input[name="${name}"]:checked`);
  return selected ? selected.value : '';
}

function search() {
  fetch(gasURL + '?mode=search')
    .then(res => res.json())
    .then(data => {
      const keyword = document.getElementById('searchInput').value.trim();
      const results = data.filter(item =>
        item.carNumber.includes(keyword) || item.owner.includes(keyword)
      );
      const output = results.map(r =>
        `日時: ${r.timestamp} / 記録者: ${r.user} / 車両番号: ${r.carNumber} / オーナー名: ${r.owner}\n` +
        `エンジン: ${r.engine} / ブレーキ: ${r.brake} / トランスミッション: ${r.transmission} / サスペンション: ${r.suspension}\n` +
        `アーマー: ${r.armor} / ターボ: ${r.turbo} / ハーネス: ${r.harness} / NOS: ${r.nos}`
      ).join('\n\n');
      document.getElementById('results').textContent = output || '該当なし';
    });
}
</script>

</body>
</html>
