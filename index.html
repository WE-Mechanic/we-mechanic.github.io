<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>性能カスタム記録フォーム</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .row { display: flex; align-items: center; margin-bottom: 8px; }
    .row label { width: 100px; }
    input[type="text"], select { width: 200px; margin-right: 10px; }
    table { border-collapse: collapse; margin-top: 20px; }
    td { padding: 4px 8px; }
    .section-title { margin-top: 16px; font-weight: bold; }
    .checkbox-group label { margin-right: 12px; }
  </style>
</head>
<body>
  <h2>性能カスタム記録フォーム</h2>

  <div id="loginSection"></div>

  <div id="formSection" style="display:none;">
    <div class="row">
      <label>記録者名</label>
      <select id="recorder" disabled></select>
    </div>
    <div class="row">
      <label>車両番号</label>
      <input type="text" id="vehicleNumber" />
    </div>
    <div class="row">
      <label>オーナー名</label>
      <input type="text" id="ownerName" />
    </div>

    <div class="section-title">性能カスタム</div>
    <table>
      <tr>
        <td>エンジン</td>
        <td>
          <label><input type="radio" name="engine" value="ティア1">ティア1</label>
          <label><input type="radio" name="engine" value="ティア2">ティア2</label>
          <label><input type="radio" name="engine" value="ティア3">ティア3</label>
          <label><input type="radio" name="engine" value="ティア4">ティア4</label>
          <label><input type="radio" name="engine" value="ティア5">ティア5</label>
        </td>
      </tr>
      <tr>
        <td>ブレーキ</td>
        <td>
          <label><input type="radio" name="brake" value="ティア1">ティア1</label>
          <label><input type="radio" name="brake" value="ティア2">ティア2</label>
          <label><input type="radio" name="brake" value="ティア3">ティア3</label>
        </td>
      </tr>
      <tr>
        <td>ミッション</td>
        <td>
          <label><input type="radio" name="transmission" value="ティア1">ティア1</label>
          <label><input type="radio" name="transmission" value="ティア2">ティア2</label>
          <label><input type="radio" name="transmission" value="ティア3">ティア3</label>
          <label><input type="radio" name="transmission" value="ティア4">ティア4</label>
        </td>
      </tr>
      <tr>
        <td>サス</td>
        <td>
          <label><input type="radio" name="suspension" value="ティア1">ティア1</label>
          <label><input type="radio" name="suspension" value="ティア2">ティア2</label>
          <label><input type="radio" name="suspension" value="ティア3">ティア3</label>
          <label><input type="radio" name="suspension" value="ティア4">ティア4</label>
          <label><input type="radio" name="suspension" value="ティア5">ティア5</label>
        </td>
      </tr>
      <tr>
        <td>その他</td>
        <td class="checkbox-group">
          <label><input type="checkbox" id="armor">アーマー</label>
          <label><input type="checkbox" id="turbo">ターボ</label>
          <label><input type="checkbox" id="harness">ハーネス</label>
          <label><input type="checkbox" id="nos">NOS</label>
        </td>
      </tr>
    </table>

    <button onclick="submitForm()">記録する</button>

    <hr />
    <div class="row">
      <label>検索:</label>
      <input type="text" id="searchQuery" />
      <button onclick="searchData()">検索</button>
    </div>
    <div id="results"></div>
  </div>

  <script>
    let token = "";
    const scriptURL = "https://script.google.com/macros/s/AKfycbwclG9RoxME0Dot_Ttufzlptg7eKvl3Vt6MneNxQJxeKbk3xWYd0RvbVzcrXYiwcWfH/exec";

    function handleCredentialResponse(response) {
      token = response.credential;
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ token: token, mode: "auth" })
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById("formSection").style.display = "block";
            const recorder = document.getElementById("recorder");
            recorder.innerHTML = `<option>${data.userName}</option>`;
            document.getElementById("loginSection").style.display = "none";
          } else {
            alert("認証に失敗しました");
          }
        });
    }

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "735792055029-5qb8bcm39qg7g8qrsh60di4pq87afos3.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementById("loginSection"),
        { theme: "outline", size: "large" }
      );
    };

    function submitForm() {
      const data = {
        token,
        mode: "submit",
        vehicleNumber: document.getElementById("vehicleNumber").value,
        ownerName: document.getElementById("ownerName").value,
        engine: document.querySelector('input[name="engine"]:checked')?.value || "",
        brake: document.querySelector('input[name="brake"]:checked')?.value || "",
        transmission: document.querySelector('input[name="transmission"]:checked')?.value || "",
        suspension: document.querySelector('input[name="suspension"]:checked')?.value || "",
        armor: document.getElementById("armor").checked,
        turbo: document.getElementById("turbo").checked,
        harness: document.getElementById("harness").checked,
        nos: document.getElementById("nos").checked
      };

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data)
      })
        .then(res => res.text())
        .then(msg => alert(msg));
    }

    function searchData() {
      const query = document.getElementById("searchQuery").value;
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ token, mode: "search", query })
      })
        .then(res => res.json())
        .then(data => {
          const results = document.getElementById("results");
          if (data.length === 0) {
            results.innerHTML = "一致するデータがありません。";
            return;
          }
          results.innerHTML = data.map(row => `
            <div style="margin-bottom:12px;">
              日時: ${row.date} / 記録者: ${row.userName} <br />
              車両番号: ${row.vehicleNumber} / オーナー名: ${row.ownerName} <br />
              エンジン: ${row.engine || ""} <br />
              ブレーキ: ${row.brake || ""} <br />
              ミッション: ${row.transmission || ""} <br />
              サス: ${row.suspension || ""} <br />
              ${["armor", "turbo", "harness", "nos"].filter(k => row[k] === "ON").map(k => ({
                armor: "アーマー", turbo: "ターボ", harness: "ハーネス", nos: "NOS"
              }[k])).join(", ")}
            </div>
          `).join("");
        });
    }
  </script>
</body>
</html>
